name: Text Snow Road With Trees

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Render text scene
        shell: bash
        run: |
          WIDTH=45
          HEIGHT=45

          # ===== СИМВОЛЫ НЕБА =====
          SKY_SMALL="· ˑ ː ˘ ˙"
          SKY_SNOW="❄ ✼ ❅ ✻"
          SKY_SHINE="⋆ ✧ ✦"

          # ===== СПРАЙТЫ ДЕРЕВА (LOD) =====
          TREE_FAR=(
            " ^ "
          )

          TREE_MID=(
            " ^ "
            "/|\\"
          )

          TREE_NEAR=(
            "  ^  "
            " /***\\ "
            "/*****\\"
            "   |   "
          )

          # ===== ЭКРАННЫЙ БУФЕР =====
          declare -A SCREEN
          for ((y=1; y<=HEIGHT; y++)); do
            for ((x=1; x<=WIDTH; x++)); do
              SCREEN[$y,$x]=" "
            done
          done

          # ===== ФУНКЦИЯ РИСОВАНИЯ ОБЪЕКТА =====
          draw_object() {
            local sy=$1
            local sx=$2
            shift 2
            local sprite=("$@")

            for ((yy=0; yy<${#sprite[@]}; yy++)); do
              row="${sprite[$yy]}"
              for ((xx=0; xx<${#row}; xx++)); do
                char="${row:$xx:1}"
                if [ "$char" != " " ]; then
                  py=$((sy + yy))
                  px=$((sx + xx))
                  if [ $py -ge 1 ] && [ $py -le $HEIGHT ] && \
                     [ $px -ge 1 ] && [ $px -le $WIDTH ]; then
                    SCREEN[$py,$px]="$char"
                  fi
                fi
              done
            done
          }

          # ===== ГОРИЗОНТ =====
          HORIZON_Y=$((HEIGHT / 3))

          # ===== РАЗМЕЩЕНИЕ ДЕРЕВЬЕВ (ОДИН РАЗ) =====
          TREES_Y=()
          TREES_X=()
          TREES_LOD=()

          for ((i=0; i<14; i++)); do
            TY=$((HORIZON_Y + 2 + RANDOM % (HEIGHT - HORIZON_Y - 6)))

            if [ $TY -lt $((HORIZON_Y + 6)) ]; then
              LOD=0
            elif [ $TY -lt $((HORIZON_Y + 16)) ]; then
              LOD=1
            else
              LOD=2
            fi

            if [ $((RANDOM % 2)) -eq 0 ]; then
              TX=$((WIDTH / 2 - 28))
            else
              TX=$((WIDTH / 2 + 22))
            fi

            TREES_Y+=($TY)
            TREES_X+=($TX)
            TREES_LOD+=($LOD)
          done

          # ===== РЕНДЕР НЕБА + ДОРОГИ =====
          for ((y=1; y<=HEIGHT; y++)); do

            ROAD_TOP=6
            ROAD_BOTTOM=50

            if [ $y -gt $HORIZON_Y ]; then
              T=$(( (y - HORIZON_Y) * 100 / (HEIGHT - HORIZON_Y) ))
              ROAD_WIDTH=$(( ROAD_TOP + (ROAD_BOTTOM - ROAD_TOP) * T / 100 ))
            else
              ROAD_WIDTH=$ROAD_TOP
            fi

            ROAD_LEFT=$(( (WIDTH - ROAD_WIDTH) / 2 ))
            ROAD_RIGHT=$(( ROAD_LEFT + ROAD_WIDTH ))
            ROAD_CENTER=$(( (ROAD_LEFT + ROAD_RIGHT) / 2 ))

            for ((x=1; x<=WIDTH; x++)); do

              if [ $y -eq $HORIZON_Y ]; then
                CHAR="─"

              elif [ $y -gt $HORIZON_Y ] && [ $x -ge $ROAD_LEFT ] && [ $x -le $ROAD_RIGHT ]; then
                if [ $x -eq $ROAD_CENTER ] && [ $((y % 2)) -eq 0 ]; then
                  CHAR="│"
                else
                  CHAR="░"
                fi

              else
                R=$((RANDOM % 20))
                if [ $R -eq 0 ]; then
                  CHAR=$(echo "$SKY_SNOW" | tr " " "\n" | shuf -n 1)
                elif [ $R -eq 1 ]; then
                  CHAR=$(echo "$SKY_SHINE" | tr " " "\n" | shuf -n 1)
                else
                  CHAR=$(echo "$SKY_SMALL" | tr " " "\n" | shuf -n 1)
                fi
              fi

              SCREEN[$y,$x]="$CHAR"
            done
          done

          # ===== РЕНДЕР ДЕРЕВЬЕВ =====
          for ((i=0; i<${#TREES_Y[@]}; i++)); do
            case ${TREES_LOD[$i]} in
              0) draw_object ${TREES_Y[$i]} ${TREES_X[$i]} "${TREE_FAR[@]}" ;;
              1) draw_object ${TREES_Y[$i]} ${TREES_X[$i]} "${TREE_MID[@]}" ;;
              2) draw_object ${TREES_Y[$i]} ${TREES_X[$i]} "${TREE_NEAR[@]}" ;;
            esac
          done

          # ===== ВЫВОД =====
          for ((y=1; y<=HEIGHT; y++)); do
            LINE=""
            for ((x=1; x<=WIDTH; x++)); do
              LINE+="${SCREEN[$y,$x]}"
            done
            echo "$LINE"
            sleep 0.05
          done

name: Text World Engine — Seasons

on:
  schedule:
    - cron: "0 7 * * *"   # каждый день
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Render text world
        shell: bash
        run: |
          ############################
          # НАСТРОЙКИ ЭКРАНА
          ############################
          WIDTH=80
          HEIGHT=20

          ############################
          # SEED (стабильная случайность)
          ############################
          SEED=$(date +%Y%m%d)
          RANDOM=$SEED

          ############################
          # ОПРЕДЕЛЕНИЕ СЕЗОНА
          ############################
          MONTH=$(date +%m)

          case $MONTH in
            12|01|02) SEASON="winter" ;;
            03|04|05) SEASON="spring" ;;
            06|07|08) SEASON="summer" ;;
            09|10|11) SEASON="autumn" ;;
          esac

          ############################
          # СЕЗОННЫЕ ПАРАМЕТРЫ
          ############################
          case $SEASON in
            winter)
              SKY_PARTICLE="❄ ✼ ❅"
              SKY_SMALL="· ˑ ː"
              TREE_DENSITY=2
              ;;
            spring)
              SKY_PARTICLE="✿ ❀"
              SKY_SMALL="· ˑ ː"
              TREE_DENSITY=3
              ;;
            summer)
              SKY_PARTICLE="⋆ ✧"
              SKY_SMALL="· ˑ"
              TREE_DENSITY=4
              ;;
            autumn)
              SKY_PARTICLE="✻ ❁"
              SKY_SMALL="· ˑ ː"
              TREE_DENSITY=3
              ;;
          esac

          ############################
          # СПРАЙТЫ ДЕРЕВЬЕВ (LOD)
          ############################
          TREE_FAR=(" ^ ")

          TREE_MID=(
            " ^ "
            "/|\\"
          )

          TREE_NEAR=(
            "  ^  "
            " /***\\ "
            "/*****\\"
            "   |   "
          )

          ############################
          # ЭКРАННЫЙ БУФЕР
          ############################
          declare -A SCREEN
          for ((y=1; y<=HEIGHT; y++)); do
            for ((x=1; x<=WIDTH; x++)); do
              SCREEN[$y,$x]=" "
            done
          done

          ############################
          # ФУНКЦИЯ РИСОВАНИЯ СПРАЙТА
          ############################
          draw_object() {
            local sy=$1
            local sx=$2
            shift 2
            local sprite=("$@")

            for ((yy=0; yy<${#sprite[@]}; yy++)); do
              row="${sprite[$yy]}"
              for ((xx=0; xx<${#row}; xx++)); do
                char="${row:$xx:1}"
                if [ "$char" != " " ]; then
                  py=$((sy + yy))
                  px=$((sx + xx))
                  if [ $py -ge 1 ] && [ $py -le $HEIGHT ] && \
                     [ $px -ge 1 ] && [ $px -le $WIDTH ]; then
                    SCREEN[$py,$px]="$char"
                  fi
                fi
              done
            done
          }

          ############################
          # ГОРИЗОНТ И ДОРОГА
          ############################
          HORIZON_Y=$((HEIGHT / 3))
          ROAD_TOP=6
          ROAD_BOTTOM=40

          ############################
          # ФОН + ДОРОГА
          ############################
          for ((y=1; y<=HEIGHT; y++)); do

            if [ $y -gt $HORIZON_Y ]; then
              T=$(( (y - HORIZON_Y) * 100 / (HEIGHT - HORIZON_Y) ))
              ROAD_WIDTH=$(( ROAD_TOP + (ROAD_BOTTOM - ROAD_TOP) * T / 100 ))
            else
              ROAD_WIDTH=$ROAD_TOP
            fi

            ROAD_LEFT=$(( (WIDTH - ROAD_WIDTH) / 2 ))
            ROAD_RIGHT=$(( ROAD_LEFT + ROAD_WIDTH ))
            ROAD_CENTER=$(( (ROAD_LEFT + ROAD_RIGHT) / 2 ))

            for ((x=1; x<=WIDTH; x++)); do

              # ГОРИЗОНТ
              if [ $y -eq $HORIZON_Y ]; then
                CHAR="─"

              # ДОРОГА
              elif [ $y -gt $HORIZON_Y ] && [ $x -ge $ROAD_LEFT ] && [ $x -le $ROAD_RIGHT ]; then
                if [ $x -eq $ROAD_CENTER ] && [ $((y % 2)) -eq 0 ]; then
                  CHAR="│"
                else
                  CHAR="░"
                fi

              # НЕБО
              else
                R=$((RANDOM % 10))
                if [ $R -eq 0 ]; then
                  CHAR=$(echo "$SKY_PARTICLE" | tr " " "\n" | shuf -n 1)
                else
                  CHAR=$(echo "$SKY_SMALL" | tr " " "\n" | shuf -n 1)
                fi
              fi

              SCREEN[$y,$x]="$CHAR"
            done
          done

          ############################
          # ДЕРЕВЬЯ ВДОЛЬ ДОРОГИ
          ############################
          TREE_COUNT=$((HEIGHT / 2 + RANDOM % TREE_DENSITY))

          for ((i=0; i<TREE_COUNT; i++)); do
            TY=$((HORIZON_Y + 2 + RANDOM % (HEIGHT - HORIZON_Y - 5)))

            JITTER=$((RANDOM % 3 - 1))
            TY=$((TY + JITTER))

            if [ $((RANDOM % 2)) -eq 0 ]; then
              TX=$((ROAD_LEFT - 6))
            else
              TX=$((ROAD_RIGHT + 2))
            fi

            if [ $TY -lt $((HORIZON_Y + 5)) ]; then
              draw_object $TY $TX "${TREE_FAR[@]}"
            elif [ $TY -lt $((HORIZON_Y + 10)) ]; then
              draw_object $TY $TX "${TREE_MID[@]}"
            else
              draw_object $TY $TX "${TREE_NEAR[@]}"
            fi
          done

          ############################
          # ВЫВОД
          ############################
          echo ""
          echo "SEASON: $SEASON | SEED: $SEED"
          echo ""

          for ((y=1; y<=HEIGHT; y++)); do
            LINE=""
            for ((x=1; x<=WIDTH; x++)); do
              LINE+="${SCREEN[$y,$x]}"
            done
            echo "$LINE"
          done

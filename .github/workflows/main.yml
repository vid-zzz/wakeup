name: Text Road With Poles Perspective

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Render ASCII road with poles
        shell: bash
        run: |
          WIDTH=80
          HEIGHT=20

          # ===== НЕБО =====
          SKY_SMALL="· ˑ ː ˘ ˙"
          SKY_SNOW="❄ ✼"
          SKY_SHINE="⋆ ✧"

          # ===== ДЕРЕВЬЯ =====
          TREE_FAR=(" ^ ")
          TREE_MID=(" /^\\ " "  |  ")
          TREE_NEAR=("  ###  " " ##### " "  ###  " "   |   ")

          # ===== СТОЛБЫ =====
          POLE_FAR=(" | ")
          POLE_MID=(" | " " | ")
          POLE_NEAR=(" | " " | " " | " " | ")

          # ===== ЭКРАН =====
          declare -A SCREEN
          for ((y=1; y<=HEIGHT; y++)); do
            for ((x=1; x<=WIDTH; x++)); do
              SCREEN[$y,$x]=" "
            done
          done

          draw_object() {
            local sy=$1
            local sx=$2
            shift 2
            local sprite=("$@")

            for ((yy=0; yy<${#sprite[@]}; yy++)); do
              row="${sprite[$yy]}"
              for ((xx=0; xx<${#row}; xx++)); do
                char="${row:$xx:1}"
                if [ "$char" != " " ]; then
                  py=$((sy + yy))
                  px=$((sx + xx))
                  if [ $py -ge 1 ] && [ $py -le $HEIGHT ] && \
                     [ $px -ge 1 ] && [ $px -le $WIDTH ]; then
                    SCREEN[$py,$px]="$char"
                  fi
                fi
              done
            done
          }

          # ===== ГОРИЗОНТ =====
          HORIZON_Y=$((HEIGHT / 3))

          # ===== ДОРОГА + НЕБО =====
          for ((y=1; y<=HEIGHT; y++)); do
            ROAD_TOP=6
            ROAD_BOTTOM=46

            if [ $y -gt $HORIZON_Y ]; then
              T=$(( (y - HORIZON_Y) * 100 / (HEIGHT - HORIZON_Y) ))
              ROAD_WIDTH=$(( ROAD_TOP + (ROAD_BOTTOM - ROAD_TOP) * T / 100 ))
            else
              ROAD_WIDTH=$ROAD_TOP
            fi

            ROAD_LEFT=$(( (WIDTH - ROAD_WIDTH) / 2 ))
            ROAD_RIGHT=$(( ROAD_LEFT + ROAD_WIDTH ))
            ROAD_CENTER=$(( (ROAD_LEFT + ROAD_RIGHT) / 2 ))

            for ((x=1; x<=WIDTH; x++)); do
              if [ $y -eq $HORIZON_Y ]; then
                CHAR="─"
              elif [ $y -gt $HORIZON_Y ] && [ $x -ge $ROAD_LEFT ] && [ $x -le $ROAD_RIGHT ]; then
                if [ $x -eq $ROAD_CENTER ] && [ $((y % 2)) -eq 0 ]; then
                  CHAR="│"
                else
                  CHAR="░"
                fi
              else
                R=$((RANDOM % 16))
                if [ $R -eq 0 ]; then
                  CHAR=$(echo "$SKY_SNOW" | tr " " "\n" | shuf -n 1)
                elif [ $R -eq 1 ]; then
                  CHAR=$(echo "$SKY_SHINE" | tr " " "\n" | shuf -n 1)
                else
                  CHAR=$(echo "$SKY_SMALL" | tr " " "\n" | shuf -n 1)
                fi
              fi
              SCREEN[$y,$x]="$CHAR"
            done
          done

          # ===== СТОЛБЫ (ПАРАМИ ВДОЛЬ ДОРОГИ) =====
          POLES_Y=()
          POLES_X=()
          POLES_LOD=()

          for ((y=HORIZON_Y+2; y<=HEIGHT-2; y+=2)); do
            DEPTH=$(( (y - HORIZON_Y) * 100 / (HEIGHT - HORIZON_Y) ))

            OFFSET=$(( DEPTH * 22 / 100 ))

            if [ $DEPTH -lt 35 ]; then
              LOD=0
            elif [ $DEPTH -lt 70 ]; then
              LOD=1
            else
              LOD=2
            fi

            POLES_Y+=($y)
            POLES_X+=($((WIDTH/2 - OFFSET - 2)))
            POLES_LOD+=($LOD)

            POLES_Y+=($y)
            POLES_X+=($((WIDTH/2 + OFFSET + 1)))
            POLES_LOD+=($LOD)
          done

          # ===== ДЕРЕВЬЯ =====
          TREES_Y=()
          TREES_X=()
          TREES_LOD=()

          for ((i=0; i<6; i++)); do
            TY=$((HORIZON_Y + 3 + RANDOM % (HEIGHT - HORIZON_Y - 6)))
            DEPTH=$(( (TY - HORIZON_Y) * 100 / (HEIGHT - HORIZON_Y) ))

            if [ $DEPTH -lt 40 ]; then
              LOD=0
            elif [ $DEPTH -lt 70 ]; then
              LOD=1
            else
              LOD=2
            fi

            OFFSET=$(( DEPTH * 30 / 100 ))

            if [ $((RANDOM % 2)) -eq 0 ]; then
              TX=$((WIDTH/2 - OFFSET - 6))
            else
              TX=$((WIDTH/2 + OFFSET + 2))
            fi

            TREES_Y+=($TY)
            TREES_X+=($TX)
            TREES_LOD+=($LOD)
          done

          # ===== РЕНДЕР СТОЛБОВ =====
          for ((i=0; i<${#POLES_Y[@]}; i++)); do
            case ${POLES_LOD[$i]} in
              0) draw_object ${POLES_Y[$i]} ${POLES_X[$i]} "${POLE_FAR[@]}" ;;
              1) draw_object ${POLES_Y[$i]} ${POLES_X[$i]} "${POLE_MID[@]}" ;;
              2) draw_object ${POLES_Y[$i]} ${POLES_X[$i]} "${POLE_NEAR[@]}" ;;
            esac
          done

          # ===== РЕНДЕР ДЕРЕВЬЕВ =====
          for ((i=0; i<${#TREES_Y[@]}; i++)); do
            case ${TREES_LOD[$i]} in
              0) draw_object ${TREES_Y[$i]} ${TREES_X[$i]} "${TREE_FAR[@]}" ;;
              1) draw_object ${TREES_Y[$i]} ${TREES_X[$i]} "${TREE_MID[@]}" ;;
              2) draw_object ${TREES_Y[$i]} ${TREES_X[$i]} "${TREE_NEAR[@]}" ;;
            esac
          done

          # ===== ВЫВОД =====
          for ((y=1; y<=HEIGHT; y++)); do
            LINE=""
            for ((x=1; x<=WIDTH; x++)); do
              LINE+="${SCREEN[$y,$x]}"
            done
            echo "$LINE"
            sleep 0.05
          done

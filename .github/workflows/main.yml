name: ASCII Road Engine (Proper Architecture)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *"

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Render ASCII scene with layers
        shell: bash
        run: |
          WIDTH=200
          HEIGHT=20

          # ===== СИМВОЛЫ НЕБА =====
          SKY_SMALL="· ˑ ː ˘ ˙"
          SKY_SNOW="❄ ✼"
          SKY_SHINE="⋆ ✧"

          # ===== ОБЪЕКТЫ =====
          TREE_FAR=(" ^ ")
          TREE_MID=(" /^\\ " "  |  ")
          TREE_NEAR=("  ###  " " ##### " "  ###  " "   |   ")

          POLE_FAR=(" | ")
          POLE_MID=(" | " " | ")
          POLE_NEAR=(" | " " | " " | ")

          # ===== БУФЕРЫ =====
          declare -A SKY
          declare -A WORLD
          declare -A FINAL

          for ((y=1; y<=HEIGHT; y++)); do
            for ((x=1; x<=WIDTH; x++)); do
              SKY[$y,$x]=" "
              WORLD[$y,$x]=" "
              FINAL[$y,$x]=" "
            done
          done

          draw_object() {
            local sy=$1
            local sx=$2
            shift 2
            local sprite=("$@")

            for ((yy=0; yy<${#sprite[@]}; yy++)); do
              row="${sprite[$yy]}"
              for ((xx=0; xx<${#row}; xx++)); do
                char="${row:$xx:1}"
                if [ "$char" != " " ]; then
                  py=$((sy + yy))
                  px=$((sx + xx))
                  if [ $py -ge 1 ] && [ $py -le $HEIGHT ] && \
                     [ $px -ge 1 ] && [ $px -le $WIDTH ]; then
                    WORLD[$py,$px]="$char"
                  fi
                fi
              done
            done
          }

          # ===== ГОРИЗОНТ =====
          HORIZON_Y=$((HEIGHT / 3))

          # ===== НЕБО + СНЕГ (SKY) =====
          for ((y=1; y<=HEIGHT; y++)); do
            for ((x=1; x<=WIDTH; x++)); do
              if [ $y -lt $HORIZON_Y ]; then
                R=$((RANDOM % 18))
                if [ $R -eq 0 ]; then
                  SKY[$y,$x]=$(echo "$SKY_SNOW" | tr " " "\n" | shuf -n 1)
                elif [ $R -eq 1 ]; then
                  SKY[$y,$x]=$(echo "$SKY_SHINE" | tr " " "\n" | shuf -n 1)
                else
                  SKY[$y,$x]=$(echo "$SKY_SMALL" | tr " " "\n" | shuf -n 1)
                fi
              fi
            done
          done

          # ===== ДОРОГА (WORLD) =====
          for ((y=HORIZON_Y; y<=HEIGHT; y++)); do
            ROAD_TOP=6
            ROAD_BOTTOM=50

            T=$(( (y - HORIZON_Y) * 100 / (HEIGHT - HORIZON_Y + 1) ))
            ROAD_WIDTH=$(( ROAD_TOP + (ROAD_BOTTOM - ROAD_TOP) * T / 100 ))

            LEFT=$(( (WIDTH - ROAD_WIDTH) / 2 ))
            RIGHT=$(( LEFT + ROAD_WIDTH ))
            CENTER=$(( (LEFT + RIGHT) / 2 ))

            for ((x=LEFT; x<=RIGHT; x++)); do
              if [ $x -eq $CENTER ] && [ $((y % 2)) -eq 0 ]; then
                WORLD[$y,$x]="│"
              else
                WORLD[$y,$x]="░"
              fi
            done
          done

          # ===== СТОЛБЫ =====
          for ((y=HORIZON_Y+2; y<=HEIGHT-1; y+=2)); do
            DEPTH=$(( (y - HORIZON_Y) * 100 / (HEIGHT - HORIZON_Y + 1) ))
            OFFSET=$(( DEPTH * 20 / 100 ))

            if [ $DEPTH -lt 40 ]; then
              LOD=0
            elif [ $DEPTH -lt 75 ]; then
              LOD=1
            else
              LOD=2
            fi

            case $LOD in
              0) SPRITE=("${POLE_FAR[@]}") ;;
              1) SPRITE=("${POLE_MID[@]}") ;;
              2) SPRITE=("${POLE_NEAR[@]}") ;;
            esac

            draw_object $y $((WIDTH/2 - OFFSET - 2)) "${SPRITE[@]}"
            draw_object $y $((WIDTH/2 + OFFSET + 1)) "${SPRITE[@]}"
          done

          # ===== ДЕРЕВЬЯ =====
          for ((i=0; i<5; i++)); do
            TY=$((HORIZON_Y + 3 + RANDOM % (HEIGHT - HORIZON_Y - 4)))
            DEPTH=$(( (TY - HORIZON_Y) * 100 / (HEIGHT - HORIZON_Y + 1) ))
            OFFSET=$(( DEPTH * 28 / 100 ))

            if [ $DEPTH -lt 40 ]; then
              SPRITE=("${TREE_FAR[@]}")
            elif [ $DEPTH -lt 70 ]; then
              SPRITE=("${TREE_MID[@]}")
            else
              SPRITE=("${TREE_NEAR[@]}")
            fi

            if [ $((RANDOM % 2)) -eq 0 ]; then
              TX=$((WIDTH/2 - OFFSET - 6))
            else
              TX=$((WIDTH/2 + OFFSET + 2))
            fi

            draw_object $TY $TX "${SPRITE[@]}"
          done

          # ===== КОМПОЗИТ =====
          for ((y=1; y<=HEIGHT; y++)); do
            for ((x=1; x<=WIDTH; x++)); do
              if [ "${WORLD[$y,$x]}" != " " ]; then
                FINAL[$y,$x]="${WORLD[$y,$x]}"
              else
                FINAL[$y,$x]="${SKY[$y,$x]}"
              fi
            done
          done

          # ===== ВЫВОД =====
          for ((y=1; y<=HEIGHT; y++)); do
            LINE=""
            for ((x=1; x<=WIDTH; x++)); do
              LINE+="${FINAL[$y,$x]}"
            done
            echo "$LINE"
            sleep 0.05
          done
